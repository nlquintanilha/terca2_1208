import sqlite3
import pandas as pd
from datetime import datetime, date

def popular_banco_completo():
    """
    Popula o banco de dados com exemplos reais de genes, marcadores e pacientes
    relevantes para nutrigen√©tica e medicina personalizada.
    """
    
    # Conectar ao banco
    conn = sqlite3.connect("nutrigenetica.db")
    cursor = conn.cursor()
    
    print("üß¨ Populando banco com dados de exemplo...")
    
    # ========== GENES DE EXEMPLO ==========
    genes_nutrigenetica = [
        # Gene, Descri√ß√£o, Fun√ß√£o Biol√≥gica
        ("MTHFR", 
         "Metilenotetraidrofolato redutase - Gene crucial para o metabolismo do folato",
         "Codifica enzima que converte 5,10-metilenotetraidrofolato em 5-metiltetraidrofolato, forma ativa do folato. Essencial para s√≠ntese de DNA, metila√ß√£o e metabolismo da homociste√≠na."),
        
        ("COMT", 
         "Catecol-O-metiltransferase - Metabolismo de neurotransmissores e estr√≥genos",
         "Degrada dopamina, norepinefrina e epinefrina. Tamb√©m metaboliza catecolestr√≥genos. Importante para fun√ß√£o cognitiva e metabolismo hormonal."),
        
        ("CYP1A2", 
         "Citocromo P450 1A2 - Principal enzima metabolizadora da cafe√≠na",
         "Respons√°vel pelo metabolismo de ~95% da cafe√≠na consumida. Tamb√©m metaboliza outros xenobi√≥ticos e medicamentos. Determina toler√¢ncia individual √† cafe√≠na."),
        
        ("APOE", 
         "Apolipoprote√≠na E - Transporte lip√≠dico e metabolismo do colesterol",
         "Prote√≠na essencial para transporte de lip√≠dios no plasma e c√©rebro. Influencia n√≠veis de colesterol, resposta a dietas e risco cardiovascular e neurodegenerativo."),
        
        ("FTO", 
         "Fat mass and obesity-associated protein - Regula√ß√£o do peso corporal",
         "Gene associado √† obesidade e diabetes tipo 2. Regula o apetite, saciedade e gasto energ√©tico. Influencia resposta a diferentes tipos de dieta."),
        
        ("PPARA", 
         "Receptor ativado por proliferadores de peroxissoma alfa",
         "Fator de transcri√ß√£o que regula metabolismo de √°cidos graxos, gluconeog√™nese e inflama√ß√£o. Importante para resposta a √°cidos graxos √¥mega-3."),
        
        ("TCF7L2", 
         "Transcription factor 7-like 2 - Regula√ß√£o da glicemia",
         "Fator de transcri√ß√£o envolvido na via de sinaliza√ß√£o Wnt. Crucial para homeostase da glicose e fun√ß√£o das c√©lulas beta pancre√°ticas."),
        
        ("MC4R", 
         "Receptor de melanocortina 4 - Regula√ß√£o do apetite",
         "Receptor hipotal√¢mico que regula ingest√£o alimentar e gasto energ√©tico. Muta√ß√µes causam obesidade severa e resist√™ncia √† leptina."),
        
        ("FADS1", 
         "Fatty acid desaturase 1 - S√≠ntese de √°cidos graxos poli-insaturados",
         "Enzima que converte √°cidos graxos essenciais em derivados de cadeia longa. Crucial para s√≠ntese de √°cido araquid√¥nico e DHA."),
        
        ("ALDH2", 
         "Alde√≠do desidrogenase 2 - Metabolismo do √°lcool",
         "Segunda enzima na via de metaboliza√ß√£o do etanol. Variantes deficientes causam ac√∫mulo de acetalde√≠do e intoler√¢ncia ao √°lcool.")
    ]
    
    # Inserir genes
    for gene_data in genes_nutrigenetica:
        try:
            cursor.execute('''
                INSERT INTO genes (nome_gene, descricao, funcao_biologica)
                VALUES (?, ?, ?)
            ''', gene_data)
            print(f"‚úÖ Gene {gene_data[0]} inserido")
        except sqlite3.IntegrityError:
            print(f"‚ö†Ô∏è Gene {gene_data[0]} j√° existe")
    
    conn.commit()
    
    # ========== MARCADORES SNP DE EXEMPLO ==========
    marcadores_snp = [
        # (gene_id, rs_number, tipo_variante, alelos, descricao, nivel_evidencia, score, pmids)
        
        # MTHFR (gene_id = 1)
        (1, "rs1801133", "missense", "C/T", 
         "Variante C677T (Ala222Val) - Reduz atividade enzim√°tica em 35% (CT) a 70% (TT). Associada a n√≠veis elevados de homociste√≠na, especialmente com baixo folato. Aumenta necessidade de folato e B12.",
         "Forte", 9.2, "17519439,18203168,19303062"),
        
        (1, "rs1801131", "missense", "A/C", 
         "Variante A1298C (Glu429Ala) - Reduz atividade enzim√°tica em ~25%. Efeito sin√©rgico com C677T. Associada a n√≠veis de folato e resposta a suplementa√ß√£o.",
         "Moderada", 7.8, "17519439,19303062,15389643"),
        
        # COMT (gene_id = 2)
        (2, "rs4680", "missense", "G/A", 
         "Variante Val158Met - Met/Met (AA) tem atividade enzim√°tica 3-4x menor. Afeta degrada√ß√£o de dopamina no c√≥rtex pr√©-frontal. Influencia fun√ß√£o cognitiva, estresse e metabolismo de estr√≥genos.",
         "Forte", 8.9, "16648218,17992266,18165968"),
        
        # CYP1A2 (gene_id = 3)
        (3, "rs762551", "upstream", "A/C", 
         "Variante -163C>A na regi√£o promotora. AA s√£o metabolizadores r√°pidos de cafe√≠na (~1A), CC s√£o lentos (~1F). Determina toler√¢ncia √† cafe√≠na e risco cardiovascular associado.",
         "Forte", 8.7, "15832849,17035307,19664148"),
        
        (3, "rs2069514", "intron", "G/A", 
         "Variante intr√¥nica em liga√ß√£o com rs762551. Afeta express√£o da CYP1A2. Relacionado √† velocidade de metaboliza√ß√£o da cafe√≠na e outros substratos.",
         "Moderada", 6.8, "19664148,21270894"),
        
        # APOE (gene_id = 4)
        (4, "rs429358", "missense", "T/C", 
         "Variante que define alelo Œµ4 (junto com rs7412). Œµ4/Œµ4 tem n√≠veis mais altos de colesterol LDL, maior risco cardiovascular e de Alzheimer. Responde melhor a dietas com baixo teor de gordura saturada.",
         "Forte", 9.5, "17173050,19060906,22677642"),
        
        (4, "rs7412", "missense", "C/T", 
         "Variante que define alelo Œµ2. Œµ2/Œµ2 tem n√≠veis mais baixos de colesterol, prote√ß√£o cardiovascular. Pode ter defici√™ncia de vitamina E.",
         "Forte", 9.1, "17173050,19060906,22677642"),
        
        # FTO (gene_id = 5)
        (5, "rs9939609", "intron", "A/T", 
         "Variante mais estudada do FTO. AA t√™m 1.7x maior risco de obesidade, maior IMC (~1.2 kg/m¬≤), maior ingest√£o cal√≥rica. Respondem melhor a dietas hipocal√≥ricas e exerc√≠cios.",
         "Forte", 8.4, "17434869,18454148,19079260"),
        
        (5, "rs1558902", "intron", "A/T", 
         "Variante em liga√ß√£o com rs9939609. AA associados a maior IMC, gordura corporal e ingest√£o energ√©tica. Intera√ß√£o significativa com atividade f√≠sica.",
         "Moderada", 7.6, "18454148,19079260"),
        
        # PPARA (gene_id = 6)
        (6, "rs1800206", "missense", "G/C", 
         "Variante Leu162Val. CC t√™m maior resposta a √°cidos graxos √¥mega-3, melhor perfil lip√≠dico com suplementa√ß√£o. Associado √† sensibilidade aos efeitos anti-inflamat√≥rios dos √¥mega-3.",
         "Moderada", 7.2, "12730120,16720698,18178378"),
        
        # TCF7L2 (gene_id = 7)
        (7, "rs7903146", "intron", "C/T", 
         "Variante mais forte para diabetes tipo 2. TT t√™m 2x maior risco, pior fun√ß√£o de c√©lulas beta, maior glicemia p√≥s-prandial. Respondem melhor a dietas com baixo √≠ndice glic√™mico.",
         "Forte", 9.3, "16415884,17463246,18372903"),
        
        (7, "rs12255372", "intron", "G/T", 
         "Em liga√ß√£o com rs7903146. TT associados a diabetes tipo 2, pior toler√¢ncia √† glicose. Intera√ß√£o com carboidratos refinados.",
         "Forte", 8.8, "16415884,17463246"),
        
        # MC4R (gene_id = 8)
        (8, "rs17782313", "upstream", "T/C", 
         "Variante na regi√£o promotora. CC associados a maior IMC, circunfer√™ncia da cintura, ingest√£o energ√©tica. Resposta diferencial a restri√ß√£o cal√≥rica.",
         "Moderada", 7.1, "18454148,19079261,20376003"),
        
        # FADS1 (gene_id = 9)
        (9, "rs174547", "intron", "G/T", 
         "Variante que afeta atividade da FADS1. TT t√™m menor efici√™ncia na convers√£o de √°cido linoleico para araquid√¥nico. Maior benef√≠cio com √¥mega-3 EPA/DHA pr√©-formado.",
         "Moderada", 7.4, "19148276,20565855,21829393"),
        
        # ALDH2 (gene_id = 10)
        (10, "rs671", "missense", "G/A", 
         "Variante Glu487Lys. AA t√™m defici√™ncia completa da ALDH2, GA parcial. Causa s√≠ndrome de rubor facial com √°lcool. Prote√ß√£o contra alcoolismo, mas maior risco de c√¢ncer esof√°gico.",
         "Forte", 9.8, "19244658,20691043,22051089")
    ]
    
    # Inserir marcadores
    for marcador_data in marcadores_snp:
        try:
            cursor.execute('''
                INSERT INTO marcadores 
                (gene_id, rs_number, tipo_variante, alelos, descricao_marcador, 
                 nivel_evidencia, score_evidencia, referencias_pmid)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            ''', marcador_data)
            print(f"‚úÖ Marcador {marcador_data[1]} inserido")
        except sqlite3.IntegrityError:
            print(f"‚ö†Ô∏è Marcador {marcador_data[1]} j√° existe")
    
    conn.commit()
    
    # ========== PACIENTES DE EXEMPLO ==========
    pacientes_exemplo = [
        # (nome, cpf, data_nascimento, sexo)
        ("Maria Silva Santos", "123.456.789-01", "1985-03-15", "F"),
        ("Jo√£o Carlos Oliveira", "987.654.321-02", "1978-11-22", "M"),
        ("Ana Paula Costa", "456.789.123-03", "1992-07-08", "F")
    ]
    
    # Inserir pacientes
    pacientes_ids = []
    for paciente_data in pacientes_exemplo:
        try:
            cursor.execute('''
                INSERT INTO pacientes (nome_paciente, cpf, data_nascimento, sexo)
                VALUES (?, ?, ?, ?)
            ''', paciente_data)
            paciente_id = cursor.lastrowid
            pacientes_ids.append(paciente_id)
            print(f"‚úÖ Paciente {paciente_data[0]} inserido (ID: {paciente_id})")
        except sqlite3.IntegrityError:
            print(f"‚ö†Ô∏è Paciente {paciente_data[0]} j√° existe")
    
    conn.commit()
    
    # ========== RESULTADOS DE AN√ÅLISES ==========
    # Vamos criar an√°lises para os 3 pacientes com perfis gen√©ticos diferentes
    
    resultados_analises = [
        # Paciente 1: Maria Silva Santos - Perfil: Metabolizadora lenta, risco cardiovascular moderado
        # (paciente_id, marcador_id, genotipo, interpretacao, recomendacao, nivel_risco, observacoes)
        
        # MTHFR C677T - Homozigota variante
        (pacientes_ids[0] if pacientes_ids else 1, 1, "TT", 
         "Homozigota para variante C677T com redu√ß√£o de ~70% na atividade da MTHFR. Risco elevado de hiperhomocisteinemia, especialmente com defici√™ncia de folato/B12.",
         "Suplementa√ß√£o com 5-metiltetraidrofolato (800-1000 mcg/dia), vitamina B12 (500-1000 mcg/dia) e vitamina B6 (25-50 mg/dia). Aumentar consumo de folatos naturais (vegetais verde-escuros).", 
         "Alto", "Monitorar n√≠veis de homociste√≠na s√©rica anualmente"),
        
        # COMT Val158Met - Heterozigota
        (pacientes_ids[0] if pacientes_ids else 1, 3, "GA", 
         "Heterozigota para variante Val158Met com atividade intermedi√°ria da COMT. Degrada√ß√£o moderada de dopamina e catecolestr√≥genos.",
         "Suporte nutricional para neurotransmissores: magn√©sio (400 mg/dia), vitaminas do complexo B, antioxidantes (vitamina E, C). Evitar excesso de caf√© (m√°ximo 2 x√≠caras/dia).", 
         "Moderado", "Perfil equilibrado para fun√ß√£o cognitiva"),
        
        # CYP1A2 - Metabolizadora lenta de cafe√≠na
        (pacientes_ids[0] if pacientes_ids else 1, 4, "CC", 
         "Homozigota CC - metabolizadora lenta da cafe√≠na. Maior meia-vida da cafe√≠na (~6-8h vs 3-4h). Maior risco cardiovascular com consumo elevado.",
         "Limitar cafe√≠na a 100-200 mg/dia (1-2 x√≠caras de caf√©). Evitar cafe√≠na ap√≥s 14h. Preferir ch√°s com menor teor de cafe√≠na. Aumentar antioxidantes (polifen√≥is).", 
         "Moderado", "Sensibilidade aumentada aos efeitos da cafe√≠na"),
        
        # APOE - Perfil protetor
        (pacientes_ids[0] if pacientes_ids else 1, 6, "CT", 
         "Heterozigota portando alelo Œµ2 (protetor). N√≠veis mais baixos de colesterol LDL, menor risco cardiovascular. Poss√≠vel menor absor√ß√£o de vitamina E.",
         "Dieta mediterr√¢nea com √™nfase em √¥mega-3, azeite extra virgem, nozes. Suplementar vitamina E (400 UI/dia). Manter atividade f√≠sica regular.", 
         "Baixo", "Perfil gen√©tico favor√°vel para longevidade"),
        
        # Paciente 2: Jo√£o Carlos Oliveira - Perfil: Metabolizador r√°pido, predisposi√ß√£o √† obesidade
        
        # FTO - Homozigota de risco
        (pacientes_ids[1] if len(pacientes_ids) > 1 else 2, 7, "AA", 
         "Homozigota AA com maior predisposi√ß√£o √† obesidade. Aumento de ~3 kg no peso corporal, maior apetite e prefer√™ncia por alimentos cal√≥ricos.",
         "Dieta hipocal√≥rica estruturada (d√©ficit 500-750 kcal/dia), exerc√≠cios regulares (150 min/semana moderado + 75 min intenso). Prote√≠na 1.2-1.6 g/kg. Controle de por√ß√µes rigoroso.", 
         "Alto", "Necessita acompanhamento nutricional intensivo"),
        
        # TCF7L2 - Heterozigota para diabetes
        (pacientes_ids[1] if len(pacientes_ids) > 1 else 2, 9, "CT", 
         "Heterozigota CT com risco aumentado (40%) para diabetes tipo 2. Pior fun√ß√£o das c√©lulas beta pancre√°ticas e maior glicemia p√≥s-prandial.",
         "Dieta com baixo √≠ndice glic√™mico, carboidratos complexos, fibras >30g/dia. Evitar a√ß√∫cares refinados e bebidas a√ßucaradas. Exerc√≠cios p√≥s-prandiais. Cromo picolinato (200-400 mcg/dia).", 
         "Alto", "Monitorar glicemia e HbA1c semestralmente"),
        
        # CYP1A2 - Metabolizador r√°pido
        (pacientes_ids[1] if len(pacientes_ids) > 1 else 2, 4, "AA", 
         "Homozigota AA - metabolizador r√°pido da cafe√≠na. Menor risco cardiovascular associado ao consumo de caf√©. Poss√≠vel efeito protetor com consumo moderado.",
         "Pode consumir at√© 400 mg cafe√≠na/dia (4 x√≠caras de caf√©) com seguran√ßa. Aproveitar benef√≠cios antioxidantes do caf√©. Manter hidrata√ß√£o adequada.", 
         "Baixo", "Toler√¢ncia aumentada √† cafe√≠na - pode usar como ergog√™nico"),
        
        # ALDH2 - Fun√ß√£o normal
        (pacientes_ids[1] if len(pacientes_ids) > 1 else 2, 14, "GG", 
         "Homozigota GG com fun√ß√£o normal da ALDH2. Metaboliza√ß√£o eficiente do √°lcool sem ac√∫mulo de acetalde√≠do.",
         "Consumo moderado de √°lcool se desejado (m√°ximo 2 doses/dia). Priorizar vinhos tintos pelos antioxidantes. Sempre com alimentos para reduzir absor√ß√£o.", 
         "Baixo", "Sem restri√ß√µes gen√©ticas para metabolismo do √°lcool"),
        
        # Paciente 3: Ana Paula Costa - Perfil: Jovem, necessidades espec√≠ficas de √¥mega-3
        
        # FADS1 - Baixa efici√™ncia de convers√£o
        (pacientes_ids[2] if len(pacientes_ids) > 2 else 3, 13, "TT", 
         "Homozigota TT com baixa atividade da FADS1. Convers√£o reduzida (50-70%) de √°cido linoleico para araquid√¥nico e de ALA para EPA/DHA.",
         "Suplementa√ß√£o com √¥mega-3 EPA/DHA pr√©-formado (1-2g/dia). Reduzir √¥mega-6 (√≥leos vegetais refinados). Preferir peixes gordos 3x/semana ou suplemento de √≥leo de peixe.", 
         "Moderado", "Depend√™ncia aumentada de √¥mega-3 de origem marinha"),
        
        # PPARA - Boa resposta a √¥mega-3
        (pacientes_ids[2] if len(pacientes_ids) > 2 else 3, 8, "CC", 
         "Homozigota CC com maior sensibilidade aos efeitos ben√©ficos dos √°cidos graxos √¥mega-3. Melhor resposta anti-inflamat√≥ria e no perfil lip√≠dico.",
         "Maximizar consumo de √¥mega-3: peixes gordos, nozes, linha√ßa, chia. Suplemento EPA/DHA 1-2g/dia. Azeite extra virgem como gordura principal. Abacate, azeitonas.", 
         "Baixo", "Perfil gen√©tico favor√°vel para benef√≠cios dos √¥mega-3"),
        
        # MTHFR A1298C - Heterozigota
        (pacientes_ids[2] if len(pacientes_ids) > 2 else 3, 2, "AC", 
         "Heterozigota AC com redu√ß√£o moderada (25%) na atividade da MTHFR. Metabolismo do folato levemente comprometido, especialmente em mulheres em idade reprodutiva.",
         "Suplementa√ß√£o preventiva com metilfolato (400-800 mcg/dia), especialmente se planeja gravidez. Vitamina B12 (250 mcg/dia). Dieta rica em folatos naturais.", 
         "Moderado", "Importante para planejamento reprodutivo"),
        
        # MC4R - Heterozigota
        (pacientes_ids[2] if len(pacientes_ids) > 2 else 3, 12, "TC", 
         "Heterozigota TC com risco moderadamente aumentado para ganho de peso. Regula√ß√£o do apetite e saciedade levemente comprometida.",
         "Dieta equilibrada com prote√≠na adequada (1.0-1.2 g/kg), fibras >25g/dia para saciedade. Exerc√≠cios regulares. Aten√ß√£o aos sinais de saciedade. Evitar alimentos ultraprocessados.", 
         "Moderado", "Preventivo - manter peso saud√°vel desde jovem")
    ]
    
    # Inserir resultados das an√°lises
    for resultado_data in resultados_analises:
        try:
            cursor.execute('''
                INSERT INTO resultados_analises 
                (paciente_id, marcador_id, genotipo_encontrado, interpretacao_clinica, 
                 recomendacao_nutricional, nivel_risco, observacoes)
                VALUES (?, ?, ?, ?, ?, ?, ?)
            ''', resultado_data)
            print(f"‚úÖ An√°lise inserida para paciente ID {resultado_data[0]}, marcador ID {resultado_data[1]}")
        except sqlite3.IntegrityError:
            print(f"‚ö†Ô∏è An√°lise j√° existe para paciente {resultado_data[0]}, marcador {resultado_data[1]}")
    
    conn.commit()
    conn.close()
    
    print("\nüéâ Banco de dados populado com sucesso!")
    print("\nüìä Resumo dos dados inseridos:")
    print("‚Ä¢ 10 genes relevantes para nutrigen√©tica")
    print("‚Ä¢ 14 marcadores SNP com evid√™ncia cient√≠fica")
    print("‚Ä¢ 3 pacientes com perfis gen√©ticos distintos")
    print("‚Ä¢ 12 an√°lises gen√©ticas completas")
    
    print("\nüë• Perfis dos Pacientes:")
    print("‚Ä¢ Maria Silva Santos: Metabolizadora lenta, risco cardiovascular moderado")
    print("‚Ä¢ Jo√£o Carlos Oliveira: Predisposi√ß√£o √† obesidade e diabetes, metabolizador r√°pido de cafe√≠na")
    print("‚Ä¢ Ana Paula Costa: Necessidades espec√≠ficas de √¥mega-3, perfil reprodutivo")

def mostrar_estatisticas_banco():
    """
    Mostra estat√≠sticas do banco de dados ap√≥s popula√ß√£o.
    """
    conn = sqlite3.connect("nutrigenetica.db")
    
    print("\nüìà Estat√≠sticas do Banco de Dados:")
    print("=" * 50)
    
    # Genes por n√≠vel de evid√™ncia dos marcadores
    df_evidencia = pd.read_sql_query('''
        SELECT 
            m.nivel_evidencia,
            COUNT(*) as quantidade,
            AVG(m.score_evidencia) as score_medio
        FROM marcadores m
        GROUP BY m.nivel_evidencia
        ORDER BY score_medio DESC
    ''', conn)
    
    print("\nüß¨ Marcadores por N√≠vel de Evid√™ncia:")
    print(df_evidencia.to_string(index=False))
    
    # An√°lises por n√≠vel de risco
    df_risco = pd.read_sql_query('''
        SELECT 
            r.nivel_risco,
            COUNT(*) as quantidade
        FROM resultados_analises r
        GROUP BY r.nivel_risco
        ORDER BY 
            CASE r.nivel_risco 
                WHEN 'Alto' THEN 3 
                WHEN 'Moderado' THEN 2 
                ELSE 1 
            END DESC
    ''', conn)
    
    print("\n‚ö†Ô∏è An√°lises por N√≠vel de Risco:")
    print(df_risco.to_string(index=False))
    
    # Genes mais analisados
    df_genes = pd.read_sql_query('''
        SELECT 
            g.nome_gene,
            COUNT(r.resultado_id) as total_analises
        FROM genes g
        LEFT JOIN marcadores m ON g.gene_id = m.gene_id
        LEFT JOIN resultados_analises r ON m.marcador_id = r.marcador_id
        GROUP BY g.nome_gene
        HAVING total_analises > 0
        ORDER BY total_analises DESC
    ''', conn)
    
    print("\nüèÜ Genes Mais Analisados:")
    print(df_genes.to_string(index=False))
    
    conn.close()

if __name__ == "__main__":
    # Execute esta fun√ß√£o para popular o banco de dados
    popular_banco_completo()
    
    # Mostre estat√≠sticas
    mostrar_estatisticas_banco()
    
    print("\nüöÄ Agora voc√™ pode executar o sistema principal:")
    print("streamlit run nutrigenetica.py")
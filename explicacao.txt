# ExplicaÃ§Ã£o Detalhada do CÃ³digo - Sistema de NutrigenÃ©tica

## Estrutura Geral do Projeto

O projeto Ã© construÃ­do usando trÃªs tecnologias principais:
- **SQLite**: Banco de dados relacional leve para armazenamento local
- **Python**: Linguagem de programaÃ§Ã£o principal com bibliotecas cientÃ­ficas
- **Streamlit**: Framework para criaÃ§Ã£o de aplicaÃ§Ãµes web interativas

## ImportaÃ§Ãµes e ConfiguraÃ§Ãµes Iniciais

```python
import streamlit as st
import sqlite3
import pandas as pd
from datetime import datetime, date
import hashlib
```

**ExplicaÃ§Ã£o das importaÃ§Ãµes:**
- `streamlit`: Framework para interface web interativa
- `sqlite3`: MÃ³dulo nativo do Python para trabalhar com banco SQLite
- `pandas`: Biblioteca para manipulaÃ§Ã£o de dados tabulares
- `datetime`: Para trabalhar com datas e horÃ¡rios
- `hashlib`: Para funÃ§Ãµes de hash (caso necessÃ¡rio para seguranÃ§a)

```python
st.set_page_config(
    page_title="Sistema de NutrigenÃ©tica",
    page_icon="ðŸ§¬",
    layout="wide"
)
```

**ConfiguraÃ§Ã£o da pÃ¡gina Streamlit:**
- `page_title`: Define o tÃ­tulo que aparece na aba do navegador
- `page_icon`: Emoji que aparece na aba
- `layout="wide"`: Utiliza toda a largura da tela

## Classe DatabaseManager

### InicializaÃ§Ã£o

```python
def __init__(self, db_name="nutrigenetica.db"):
    self.db_name = db_name
    self.init_database()
```

**ExplicaÃ§Ã£o:**
- Define o nome padrÃ£o do arquivo do banco de dados
- Chama automaticamente a funÃ§Ã£o `init_database()` para criar as tabelas

### ConexÃ£o com o Banco

```python
def get_connection(self):
    return sqlite3.connect(self.db_name)
```

**ExplicaÃ§Ã£o:**
- Cria uma nova conexÃ£o SQLite sempre que chamada
- Retorna o objeto de conexÃ£o para executar comandos SQL

### CriaÃ§Ã£o das Tabelas

```python
def init_database(self):
    conn = self.get_connection()
    cursor = conn.cursor()
```

**ExplicaÃ§Ã£o:**
- ObtÃ©m uma conexÃ£o com o banco
- Cria um cursor para executar comandos SQL

#### Tabela GENES

```python
cursor.execute('''
    CREATE TABLE IF NOT EXISTS genes (
        gene_id INTEGER PRIMARY KEY AUTOINCREMENT,
        nome_gene TEXT NOT NULL UNIQUE,
        descricao TEXT,
        funcao_biologica TEXT,
        data_criacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )
''')
```

**ExplicaÃ§Ã£o detalhada dos campos:**
- `gene_id`: Chave primÃ¡ria que incrementa automaticamente
- `nome_gene`: Nome do gene (obrigatÃ³rio e Ãºnico)
- `descricao`: DescriÃ§Ã£o textual do gene
- `funcao_biologica`: FunÃ§Ã£o biolÃ³gica do gene
- `data_criacao`: Timestamp automÃ¡tico de quando foi criado

#### Tabela MARCADORES

```python
cursor.execute('''
    CREATE TABLE IF NOT EXISTS marcadores (
        marcador_id INTEGER PRIMARY KEY AUTOINCREMENT,
        gene_id INTEGER NOT NULL,
        rs_number TEXT NOT NULL UNIQUE,
        tipo_variante TEXT,
        alelos TEXT,
        descricao_marcador TEXT,
        nivel_evidencia TEXT CHECK (nivel_evidencia IN ('Forte', 'Moderada', 'Limitada', 'Insuficiente')),
        score_evidencia REAL CHECK (score_evidencia >= 0 AND score_evidencia <= 10),
        referencias_pmid TEXT,
        data_criacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (gene_id) REFERENCES genes (gene_id)
    )
''')
```

**ExplicaÃ§Ã£o detalhada:**
- `marcador_id`: Chave primÃ¡ria
- `gene_id`: Chave estrangeira referenciando a tabela genes
- `rs_number`: NÃºmero RS do SNP (Ãºnico)
- `CHECK` constraints: Garantem que os valores estejam dentro dos limites permitidos
- `FOREIGN KEY`: Estabelece relaÃ§Ã£o com a tabela genes

#### Tabela PACIENTES

```python
cursor.execute('''
    CREATE TABLE IF NOT EXISTS pacientes (
        paciente_id INTEGER PRIMARY KEY AUTOINCREMENT,
        nome_paciente TEXT NOT NULL,
        cpf TEXT UNIQUE,
        data_nascimento DATE,
        sexo TEXT CHECK (sexo IN ('M', 'F')),
        data_cadastro TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )
''')
```

**ExplicaÃ§Ã£o:**
- `cpf UNIQUE`: CPF deve ser Ãºnico (permite NULL)
- `CHECK (sexo IN ('M', 'F'))`: Restringe valores a apenas M ou F

#### Tabela RESULTADOS_ANALISES

```python
cursor.execute('''
    CREATE TABLE IF NOT EXISTS resultados_analises (
        resultado_id INTEGER PRIMARY KEY AUTOINCREMENT,
        paciente_id INTEGER NOT NULL,
        marcador_id INTEGER NOT NULL,
        genotipo_encontrado TEXT NOT NULL,
        interpretacao_clinica TEXT,
        recomendacao_nutricional TEXT,
        nivel_risco TEXT CHECK (nivel_risco IN ('Baixo', 'Moderado', 'Alto')),
        data_analise TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        observacoes TEXT,
        FOREIGN KEY (paciente_id) REFERENCES pacientes (paciente_id),
        FOREIGN KEY (marcador_id) REFERENCES marcadores (marcador_id),
        UNIQUE(paciente_id, marcador_id)
    )
''')
```

**ExplicaÃ§Ã£o:**
- Duas chaves estrangeiras: `paciente_id` e `marcador_id`
- `UNIQUE(paciente_id, marcador_id)`: Evita duplicatas da mesma anÃ¡lise

## MÃ©todos de InserÃ§Ã£o (CRUD - Create)

### Inserir Gene

```python
def inserir_gene(self, nome_gene, descricao, funcao_biologica):
    try:
        conn = self.get_connection()
        cursor = conn.cursor()
        cursor.execute('''
            INSERT INTO genes (nome_gene, descricao, funcao_biologica)
            VALUES (?, ?, ?)
        ''', (nome_gene, descricao, funcao_biologica))
        conn.commit()
        conn.close()
        return True
    except sqlite3.IntegrityError:
        return False
```

**ExplicaÃ§Ã£o:**
- `try/except`: Captura erros de integridade (ex: nome duplicado)
- `?` placeholders: Previne SQL injection
- `conn.commit()`: Confirma as alteraÃ§Ãµes no banco
- `conn.close()`: Fecha a conexÃ£o
- Retorna `True` se sucesso, `False` se erro

### Inserir Marcador

```python
def inserir_marcador(self, gene_id, rs_number, tipo_variante, alelos, 
                    descricao_marcador, nivel_evidencia, score_evidencia, referencias_pmid):
```

**ExplicaÃ§Ã£o:**
- Mesmo padrÃ£o do mÃ©todo anterior
- Mais parÃ¢metros devido Ã  complexidade da tabela marcadores
- Trata violaÃ§Ãµes de integridade (rs_number duplicado)

## MÃ©todos de Consulta (CRUD - Read)

### Consulta com JOIN

```python
def get_marcadores(self):
    conn = self.get_connection()
    df = pd.read_sql_query('''
        SELECT m.*, g.nome_gene 
        FROM marcadores m 
        JOIN genes g ON m.gene_id = g.gene_id 
        ORDER BY g.nome_gene, m.rs_number
    ''', conn)
    conn.close()
    return df
```

**ExplicaÃ§Ã£o:**
- `pd.read_sql_query()`: Executa SQL e retorna DataFrame pandas
- `JOIN`: Combina dados das tabelas marcadores e genes
- `m.*`: Seleciona todas as colunas da tabela marcadores
- `ORDER BY`: Ordena resultados por gene e depois por rs_number

### RelatÃ³rio Complexo

```python
def get_relatorio_paciente(self, paciente_id):
    conn = self.get_connection()
    df = pd.read_sql_query('''
        SELECT 
            p.nome_paciente,
            p.cpf,
            p.data_nascimento,
            p.sexo,
            g.nome_gene,
            m.rs_number,
            m.descricao_marcador,
            m.nivel_evidencia,
            m.score_evidencia,
            r.genotipo_encontrado,
            r.interpretacao_clinica,
            r.recomendacao_nutricional,
            r.nivel_risco,
            r.data_analise,
            r.observacoes
        FROM resultados_analises r
        JOIN pacientes p ON r.paciente_id = p.paciente_id
        JOIN marcadores m ON r.marcador_id = m.marcador_id
        JOIN genes g ON m.gene_id = g.gene_id
        WHERE p.paciente_id = ?
        ORDER BY g.nome_gene, m.rs_number
    ''', conn, params=(paciente_id,))
    conn.close()
    return df
```

**ExplicaÃ§Ã£o:**
- Query com mÃºltiplos JOINs para combinar 4 tabelas
- `WHERE p.paciente_id = ?`: Filtra por um paciente especÃ­fico
- `params=(paciente_id,)`: ParÃ¢metro seguro para a query

## Interface Streamlit

### FunÃ§Ã£o Principal

```python
def main():
    db = DatabaseManager()
    st.title("ðŸ§¬ Sistema de NutrigenÃ©tica")
    st.markdown("### AnÃ¡lise de Polimorfismos SNP para Medicina Personalizada")
```

**ExplicaÃ§Ã£o:**
- Instancia o gerenciador do banco
- `st.title()`: TÃ­tulo principal da aplicaÃ§Ã£o
- `st.markdown()`: Texto formatado em Markdown

### NavegaÃ§Ã£o por Sidebar

```python
st.sidebar.title("NavegaÃ§Ã£o")
opcao = st.sidebar.selectbox(
    "Escolha uma funcionalidade:",
    ["ðŸ  Home", "ðŸ§¬ Cadastrar Gene", "ðŸ“ Cadastrar Marcador", 
     "ðŸ‘¤ Cadastrar Paciente", "ðŸ”¬ Registrar AnÃ¡lise", 
     "ðŸ“Š Consultar Resultados", "ðŸ“‹ RelatÃ³rios"]
)
```

**ExplicaÃ§Ã£o:**
- `st.sidebar`: Cria uma barra lateral
- `selectbox`: Menu dropdown para seleÃ§Ã£o
- Lista de opÃ§Ãµes com emojis para melhor UX

### FormulÃ¡rios Streamlit

```python
with st.form("form_gene"):
    nome_gene = st.text_input("Nome do Gene*", placeholder="Ex: MTHFR")
    descricao = st.text_area("DescriÃ§Ã£o do Gene*", placeholder="Descreva a funÃ§Ã£o e importÃ¢ncia do gene")
    funcao_biologica = st.text_area("FunÃ§Ã£o BiolÃ³gica*", placeholder="Detalhe os processos biolÃ³gicos envolvidos")
    
    submitted = st.form_submit_button("Cadastrar Gene")
```

**ExplicaÃ§Ã£o:**
- `with st.form()`: Context manager para agrupar inputs
- `st.text_input()`: Campo de texto simples
- `st.text_area()`: Campo de texto multilinha
- `placeholder`: Texto de exemplo no campo
- `st.form_submit_button()`: BotÃ£o que submete o formulÃ¡rio

### ValidaÃ§Ã£o e Feedback

```python
if submitted:
    if nome_gene and descricao and funcao_biologica:
        if db.inserir_gene(nome_gene.upper(), descricao, funcao_biologica):
            st.success(f"Gene {nome_gene} cadastrado com sucesso!")
        else:
            st.error("Gene jÃ¡ existe no banco de dados!")
    else:
        st.error("Todos os campos sÃ£o obrigatÃ³rios!")
```

**ExplicaÃ§Ã£o:**
- Verifica se formulÃ¡rio foi submetido
- Valida se campos obrigatÃ³rios estÃ£o preenchidos
- `nome_gene.upper()`: Converte para maiÃºsculas
- `st.success()`: Mensagem de sucesso (verde)
- `st.error()`: Mensagem de erro (vermelho)

### Layout em Colunas

```python
col1, col2, col3, col4 = st.columns(4)

with col1:
    genes_count = len(db.get_genes())
    st.metric("Genes Cadastrados", genes_count)
```

**ExplicaÃ§Ã£o:**
- `st.columns(4)`: Cria 4 colunas de largura igual
- `with col1:`: Context manager para trabalhar dentro da coluna
- `st.metric()`: Widget para mostrar mÃ©tricas com tÃ­tulo e valor

### Expansores (Expanders)

```python
with st.expander(f"ðŸ§¬ {row['nome_gene']} - {row['rs_number']} | Risco: {row['nivel_risco']}"):
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("**InformaÃ§Ãµes do Marcador:**")
        st.write(f"**Gene:** {row['nome_gene']}")
```

**ExplicaÃ§Ã£o:**
- `st.expander()`: Cria seÃ§Ã£o expansÃ­vel/colapsÃ¡vel
- String f-formatada para tÃ­tulo dinÃ¢mico
- `st.markdown()` com `**texto**`: Texto em negrito
- `st.write()`: FunÃ§Ã£o genÃ©rica para exibir conteÃºdo

### VisualizaÃ§Ãµes de Dados

```python
st.dataframe(genes_df, use_container_width=True)
```

**ExplicaÃ§Ã£o:**
- `st.dataframe()`: Exibe DataFrame pandas como tabela interativa
- `use_container_width=True`: Usa toda a largura disponÃ­vel

```python
evidencia_dist = marcadores_df['nivel_evidencia'].value_counts()
st.bar_chart(evidencia_dist)
```

**ExplicaÃ§Ã£o:**
- `value_counts()`: Conta ocorrÃªncias de cada valor Ãºnico
- `st.bar_chart()`: GrÃ¡fico de barras automÃ¡tico

### Abas (Tabs)

```python
tab1, tab2, tab3, tab4 = st.tabs(["Genes", "Marcadores", "Pacientes", "AnÃ¡lises"])

with tab1:
    st.subheader("RelatÃ³rio de Genes")
```

**ExplicaÃ§Ã£o:**
- `st.tabs()`: Cria interface com abas
- `with tab1:`: Context manager para conteÃºdo da aba

## Tratamento de Dados

### ConversÃ£o de Tipos

```python
genes_df['data_criacao'] = pd.to_datetime(genes_df['data_criacao'])
genes_por_mes = genes_df.groupby(genes_df['data_criacao'].dt.to_period('M')).size()
```

**ExplicaÃ§Ã£o:**
- `pd.to_datetime()`: Converte string para datetime
- `.dt.to_period('M')`: Agrupa por mÃªs
- `.size()`: Conta registros por grupo

### AgregaÃ§Ãµes

```python
score_por_gene = marcadores_df.groupby('nome_gene')['score_evidencia'].mean().sort_values(ascending=False)
```

**ExplicaÃ§Ã£o:**
- `groupby()`: Agrupa dados por gene
- `.mean()`: Calcula mÃ©dia do score
- `sort_values(ascending=False)`: Ordena decrescente

## FunÃ§Ã£o de Dados de Exemplo

```python
def popular_dados_exemplo():
    db = DatabaseManager()
    
    genes_exemplo = [
        ("MTHFR", "Metilenotetraidrofolato redutase", "Metabolismo do folato e homocisteÃ­na"),
        ("COMT", "Catecol-O-metiltransferase", "Metabolismo da dopamina e estrÃ³genos"),
        # ...
    ]
    
    for nome, desc, func in genes_exemplo:
        db.inserir_gene(nome, desc, func)
```

**ExplicaÃ§Ã£o:**
- Lista de tuplas com dados de exemplo
- Loop para inserir cada gene
- Ãštil para demonstraÃ§Ã£o e testes

## ExecuÃ§Ã£o da AplicaÃ§Ã£o

```python
if __name__ == "__main__":
    # Descomente a linha abaixo para popular com dados de exemplo na primeira execuÃ§Ã£o
    # popular_dados_exemplo()
    
    main()
```

**ExplicaÃ§Ã£o:**
- `if __name__ == "__main__":`: Executa apenas se arquivo for executado diretamente
- ComentÃ¡rio sobre funÃ§Ã£o de exemplo
- Chama funÃ§Ã£o principal

## Boas PrÃ¡ticas Implementadas

1. **SeguranÃ§a**: Uso de placeholders (`?`) para prevenir SQL injection
2. **Tratamento de Erros**: Try/except para capturar erros de integridade
3. **NormalizaÃ§Ã£o**: Banco de dados normalizado com chaves estrangeiras
4. **ValidaÃ§Ã£o**: Constraints CHECK no banco e validaÃ§Ã£o na interface
5. **UX**: Interface intuitiva com feedback claro ao usuÃ¡rio
6. **Modularidade**: SeparaÃ§Ã£o clara entre lÃ³gica de dados e interface
7. **DocumentaÃ§Ã£o**: Docstrings detalhadas em todos os mÃ©todos

## Para Executar o Sistema

1. Instale as dependÃªncias:
```bash
pip install streamlit pandas sqlite3
```

2. Salve o cÃ³digo em um arquivo (ex: `nutrigenetica.py`)

3. Execute:
```bash
streamlit run nutrigenetica.py
```

4. Acesse no navegador o endereÃ§o mostrado (geralmente `localhost:8501`)

Este sistema oferece uma base sÃ³lida para estudos de nutrigenÃ©tica, permitindo o cadastro de genes, marcadores, pacientes e anÃ¡lises, com interface web amigÃ¡vel e relatÃ³rios detalhados.